openapi: 3.1.0
info:
  title: Horizon5 MT API
  version: 1.0.0
  description: |
    Event-driven trading API for MetaTrader account management.
servers:
  - url: http://localhost:8000
    description: Local development
security:
  - bearerAuth: []
tags:
  - name: Health
    description: System health checks
  - name: Auth
    description: Authentication
  - name: API Keys
    description: API key management. Root users see all keys; regular users see only their own.
  - name: Accounts
    description: Trading account listing and upsert
  - name: Strategies
    description: Trading strategy listing and upsert
  - name: Events
    description: Event management (keys, push, consume, ack, history, response)
  - name: Media
    description: File upload and download management
  - name: Orders
    description: Trading order upsert
  - name: Heartbeats
    description: System and strategy heartbeat tracking
  - name: Logs
    description: Account and strategy log entries
  - name: Snapshots
    description: Account and strategy point-in-time snapshots
paths:
  /health/:
    get:
      tags:
        - Health
      summary: Health check
      description: |
        Returns status of PostgreSQL and MongoDB connections.

        **Permissions:** Authenticated + role `root` or `platform`.
      security:
        - bearerAuth: []
      responses:
        '200':
          description: All systems operational
          content:
            application/json:
              example:
                success: true
                data:
                  status: ok
                  checks:
                    postgres: ok
                    mongodb: ok
        '503':
          description: One or more systems degraded
          content:
            application/json:
              example:
                success: true
                data:
                  status: degraded
                  checks:
                    postgres: ok
                    mongodb: error
  /api/v1/auth/login/:
    post:
      tags:
        - Auth
      summary: Login
      description: |
        Authenticates a user and returns a JWT access/refresh token pair.

        Supports two authentication modes (mutually exclusive):
        - **Email/Password:** Provide `email` and `password` fields.
        - **API Key:** Provide `api_key` field. The key is validated against stored hashes,
          IP whitelist is checked, and expiration/active status is verified.

        **Permissions:** Public (no authentication required).

        **Rate limiting (email/password mode):**
        - Per IP: 5 requests / 60 seconds
        - Per email: 10 requests / 3600 seconds
        - Account lockout: 10 consecutive failures locks the account for 900 seconds
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              oneOf:
                - $ref: '#/components/schemas/LoginWithCredentials'
                - $ref: '#/components/schemas/LoginWithApiKey'
            examples:
              email_password:
                summary: Login with email and password
                value:
                  email: root@mail.co
                  password: 123456789*
              api_key:
                summary: Login with API key
                value:
                  api_key: a1b2c3d4e5f6...
      responses:
        '200':
          description: Login successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TokenPairResponse'
              example:
                success: true
                data:
                  access: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
                  refresh: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
                  expires_at: 1772177505
        '401':
          description: Invalid credentials or inactive account
        '403':
          description: IP not allowed (API key mode only)
  /api/v1/auth/refresh/:
    post:
      tags:
        - Auth
      summary: Refresh token
      description: |
        Exchanges a valid refresh token for a new access/refresh pair.
        The old refresh token is blacklisted (rotation).

        **Permissions:** Public (no Bearer token required).

        **Rate limiting:** 10 requests / 60 seconds per IP.
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RefreshRequest'
            example:
              refresh: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
      responses:
        '200':
          description: Token refreshed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TokenPairResponse'
              example:
                success: true
                data:
                  access: eyJ...(new)...
                  refresh: eyJ...(new, rotated)...
                  expires_at: 1772178405
        '401':
          description: Refresh token is invalid, expired, or blacklisted
          content:
            application/json:
              example:
                success: false
                message: Token is invalid or expired
        '429':
          description: Rate limit exceeded
  /api/v1/auth/logout/:
    post:
      tags:
        - Auth
      summary: Logout
      description: |
        Invalidates the refresh token server-side by blacklisting it.
        Returns success even if the token is already blacklisted (idempotent).

        **Permissions:** Authenticated (Bearer token required).
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LogoutRequest'
            example:
              refresh: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
      responses:
        '200':
          description: Logged out successfully
          content:
            application/json:
              example:
                success: true
                message: Logged out successfully
        '401':
          description: Authentication credentials were not provided
  /api/v1/auth/me/:
    get:
      tags:
        - Auth
      summary: Current user profile
      description: |
        Returns the authenticated user's profile.

        **Permissions:** Authenticated (Bearer token required).
      responses:
        '200':
          description: User profile
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserProfile'
              example:
                success: true
                data:
                  id: 4cc3a1bf-76b5-41ee-931e-9afceeea96a1
                  email: root@mail.co
                  role: root
                  created_at: '2025-01-15T10:30:00+00:00'
        '401':
          description: Authentication credentials were not provided
  /api/v1/api-keys/:
    get:
      tags:
        - API Keys
      summary: List API keys
      description: |
        Returns API keys accessible to the authenticated user.

        - **Root:** Returns all API keys across all users (includes `user_id` and `user_email`).
        - **Other roles:** Returns only the user's own API keys.

        **Permissions:** Authenticated user.
      responses:
        '200':
          description: API keys listed
          content:
            application/json:
              example:
                success: true
                data:
                  - id: 550e8400-e29b-41d4-a716-446655440000
                    name: Production Key
                    prefix: a1b2c3d4
                    allowed_ips:
                      - 192.168.1.1
                    is_active: true
                    is_expired: false
                    expires_at: null
                    last_used_at: '2026-02-26T10:30:00Z'
                    created_at: '2026-02-20T08:00:00Z'
                meta:
                  count: 1
  /api/v1/api-key/:
    post:
      tags:
        - API Keys
      summary: Create API key
      description: |
        Creates a new API key for the authenticated user.

        The plaintext key is returned **only once** in the response. Store it securely.

        **Permissions:** Authenticated user.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateApiKeyRequest'
      responses:
        '201':
          description: API key created
          content:
            application/json:
              example:
                success: true
                message: API key created. Store the key securely, it will not be shown again.
                data:
                  id: 550e8400-e29b-41d4-a716-446655440000
                  name: Production Key
                  prefix: a1b2c3d4
                  key: a1b2c3d4e5f6...full_hex_key...
                  allowed_ips:
                    - 192.168.1.1
                  is_active: true
                  expires_at: null
                  created_at: '2026-02-26T10:30:00Z'
  /api/v1/api-key/{id}/:
    get:
      tags:
        - API Keys
      summary: Show API key
      description: |
        Returns details of a specific API key.

        - **Root:** Can access any API key (response includes `user_id` and `user_email`).
        - **Other roles:** Can only access their own API keys.

        **Permissions:** Authenticated user (owner) or root.
      parameters:
        - $ref: '#/components/parameters/ApiKeyId'
      responses:
        '200':
          description: API key details
          content:
            application/json:
              example:
                success: true
                data:
                  id: 550e8400-e29b-41d4-a716-446655440000
                  name: Production Key
                  prefix: a1b2c3d4
                  allowed_ips:
                    - 192.168.1.1
                  is_active: true
                  is_expired: false
                  expires_at: null
                  last_used_at: '2026-02-26T10:30:00Z'
                  created_at: '2026-02-20T08:00:00Z'
                  updated_at: '2026-02-25T12:00:00Z'
        '404':
          description: API key not found
    patch:
      tags:
        - API Keys
      summary: Update API key
      description: |
        Updates an API key. All fields are optional; only provided fields are updated.

        - **Root:** Can update any API key.
        - **Other roles:** Can only update their own API keys.

        **Permissions:** Authenticated user (owner) or root.
      parameters:
        - $ref: '#/components/parameters/ApiKeyId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateApiKeyRequest'
      responses:
        '200':
          description: API key updated
          content:
            application/json:
              example:
                success: true
                data:
                  id: 550e8400-e29b-41d4-a716-446655440000
                  name: Updated Key Name
                  prefix: a1b2c3d4
                  allowed_ips:
                    - 10.0.0.1
                    - 10.0.0.2
                  is_active: true
                  is_expired: false
                  expires_at: null
                  last_used_at: null
                  created_at: '2026-02-20T08:00:00Z'
                  updated_at: '2026-02-26T10:30:00Z'
        '404':
          description: API key not found
    delete:
      tags:
        - API Keys
      summary: Delete API key
      description: |
        Permanently deletes an API key.

        - **Root:** Can delete any API key.
        - **Other roles:** Can only delete their own API keys.

        **Permissions:** Authenticated user (owner) or root.
      parameters:
        - $ref: '#/components/parameters/ApiKeyId'
      responses:
        '200':
          description: API key deleted
          content:
            application/json:
              example:
                success: true
                message: API key deleted.
        '404':
          description: API key not found
  /api/v1/events/keys/:
    get:
      tags:
        - Events
      summary: List event keys
      description: |
        Returns all available event keys with their names and payload schemas.

        **Permissions:** Authenticated (any role).
      responses:
        '200':
          description: List of event keys
          content:
            application/json:
              example:
                success: true
                data:
                  - key: post.order
                    name: POST_ORDER
                    schema:
                      symbol:
                        type: string
                        required: true
                      strategy:
                        type: integer
                        required: true
                      type:
                        type: string
                        required: true
                        choices:
                          - buy
                          - sell
                      volume:
                        type: float
                        required: true
                        min_value: 0.01
                      price:
                        type: float
                        required: false
                      stop_loss:
                        type: float
                        required: false
                      take_profit:
                        type: float
                        required: false
                      comment:
                        type: string
                        required: false
                        max_length: 255
                  - key: get.order
                    name: GET_ORDER
                    schema:
                      id:
                        type: integer
                        required: true
                  - key: put.order
                    name: PUT_ORDER
                    schema:
                      id:
                        type: integer
                        required: true
                      stop_loss:
                        type: float
                        required: false
                      take_profit:
                        type: float
                        required: false
                  - key: delete.order
                    name: DELETE_ORDER
                    schema:
                      id:
                        type: integer
                        required: true
                  - key: get.account
                    name: GET_ACCOUNT
                    schema: {}
                  - key: patch.account.disable
                    name: PATCH_ACCOUNT_DISABLE
                    schema: {}
                  - key: patch.account.enable
                    name: PATCH_ACCOUNT_ENABLE
                    schema: {}
  /api/v1/account/{id}/events:
    post:
      tags:
        - Events
      summary: Push event
      description: |
        Creates a new event for the specified account. The payload is validated
        against the schema defined by the event key.

        **Permissions:** `root` OR account owner with role `root` | `producer`
      parameters:
        - $ref: '#/components/parameters/AccountId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PushEventRequest'
            examples:
              post_order:
                summary: Create a buy order
                value:
                  key: post.order
                  payload:
                    symbol: EURUSD
                    strategy: 1
                    type: buy
                    volume: 0.1
                    stop_loss: 1.08
                    take_profit: 1.12
              get_account:
                summary: Request account info
                value:
                  key: get.account
                  payload: {}
      responses:
        '201':
          description: Event created
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessEnvelope'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/Event'
  /api/v1/account/{id}/events/consume/:
    post:
      tags:
        - Events
      summary: Consume events
      description: |
        Atomically claims pending events for processing. Each event transitions
        from `pending` to `delivered` and is assigned to the requesting user as consumer.

        Events are returned in FIFO order (oldest first).

        **Permissions:** `root` OR account owner with role `root` | `platform`
      parameters:
        - $ref: '#/components/parameters/AccountId'
        - name: limit
          in: query
          required: false
          description: Maximum number of events to consume (1-100, default 50)
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 50
        - name: key
          in: query
          required: false
          description: |
            Filter events by type (event key). Accepts a single key or multiple
            keys separated by commas (e.g. `post.order,get.order`).
          schema:
            type: string
          examples:
            single:
              summary: Single key
              value: post.order
            multiple:
              summary: Multiple keys
              value: post.order,get.order
      responses:
        '200':
          description: Consumed events
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessEnvelope'
                  - type: object
                    properties:
                      data:
                        type: array
                        items:
                          $ref: '#/components/schemas/Event'
                      meta:
                        type: object
                        properties:
                          count:
                            type: integer
  /api/v1/account/{id}/events/history/:
    get:
      tags:
        - Events
      summary: Event history
      description: |
        Returns events for the account, sorted by `created_at` descending (newest first).

        **Permissions:** `root` OR account owner (any role)
      parameters:
        - $ref: '#/components/parameters/AccountId'
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 50
        - name: status
          in: query
          required: false
          schema:
            $ref: '#/components/schemas/EventStatus'
        - name: key
          in: query
          required: false
          schema:
            $ref: '#/components/schemas/EventKeyEnum'
      responses:
        '200':
          description: Event list
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessEnvelope'
                  - type: object
                    properties:
                      data:
                        type: array
                        items:
                          $ref: '#/components/schemas/Event'
  /api/v1/account/{id}/event/{event_id}/ack/:
    patch:
      tags:
        - Events
      summary: Acknowledge event
      description: |
        Marks a delivered event as processed. Optionally attaches a response payload.

        Only events in `delivered` status can be acknowledged.

        **Permissions:** `root` OR account owner with role `root` | `platform`
      parameters:
        - $ref: '#/components/parameters/AccountId'
        - $ref: '#/components/parameters/EventId'
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AckEventRequest'
            examples:
              with_response:
                summary: Ack with response data
                value:
                  response:
                    ticket: 12345
                    status: filled
                    open_price: 1.105
              without_response:
                summary: Ack without response
                value: {}
      responses:
        '200':
          description: Event acknowledged
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessEnvelope'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/Event'
  /api/v1/account/{id}/event/{event_id}/response/:
    get:
      tags:
        - Events
      summary: Get event response
      description: |
        Returns the response payload attached to an acknowledged event.

        **Permissions:** `root` OR account owner with role `root` | `producer`
      parameters:
        - $ref: '#/components/parameters/AccountId'
        - $ref: '#/components/parameters/EventId'
      responses:
        '200':
          description: Event response data
          content:
            application/json:
              example:
                success: true
                data:
                  response:
                    ticket: 12345
                    status: filled
                    open_price: 1.105
  /api/v1/account/{id}/media/upload/:
    post:
      tags:
        - Media
      summary: Upload file
      description: |
        Uploads a file associated with the account. Files are stored with a unique
        name and expire after the configured expiration period (default 24 hours).

        Returns metadata about the uploaded file, including the `file_name` to use
        for downloading.

        **Permissions:** `root` OR account owner with role `root` | `platform`
      parameters:
        - $ref: '#/components/parameters/AccountId'
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required:
                - file
              properties:
                file:
                  type: string
                  format: binary
                  description: File to upload (max 1 GB)
      responses:
        '201':
          description: File uploaded
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessEnvelope'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/MediaFile'
  /api/v1/account/{id}/media/{file_name}/download/:
    get:
      tags:
        - Media
      summary: Download file
      description: |
        Downloads a file by its unique file name. Returns the file as an attachment
        with the original file name.

        Expired files return `410 Gone`.

        **Permissions:** `root` OR account owner (any role)
      parameters:
        - $ref: '#/components/parameters/AccountId'
        - $ref: '#/components/parameters/FileName'
      responses:
        '200':
          description: File content
          content:
            application/octet-stream:
              schema:
                type: string
                format: binary
        '404':
          description: File not found
        '410':
          description: File has expired
  /api/v1/account/{id}/media/{file_name}/:
    delete:
      tags:
        - Media
      summary: Delete file
      description: |
        Deletes a file by its unique file name. Removes both the database record
        and the file from disk.

        **Permissions:** `root` OR account owner with role `root` | `platform`
      parameters:
        - $ref: '#/components/parameters/AccountId'
        - $ref: '#/components/parameters/FileName'
      responses:
        '204':
          description: File deleted
        '404':
          description: File not found
  /api/v1/accounts/:
    get:
      tags:
        - Accounts
      summary: List all accounts
      description: |
        Returns all trading accounts in the system.

        **Permissions:** `root` only
      responses:
        '200':
          description: List of accounts
          content:
            application/json:
              example:
                success: true
                data:
                  - id: 12345678
                    user_id: 550e8400-e29b-41d4-a716-446655440000
                    user_email: user@example.com
                    broker: ICMarkets
                    server: ICMarketsSC-Demo
                    currency: USD
                    leverage: 500
                    balance: '10000.00'
                    equity: '10250.50'
                    margin: '200.00'
                    free_margin: '10050.50'
                    profit: '250.50'
                    margin_level: '5125.25'
                    created_at: '2026-01-15T10:30:00+00:00'
                    updated_at: '2026-01-15T12:00:00+00:00'
                meta:
                  count: 1
        '403':
          description: Insufficient permissions (non-root user)
  /api/v1/account/:
    post:
      tags:
        - Accounts
      summary: Upsert account
      description: |
        Creates or updates a trading account. If an account with the given `account_id`
        already exists and belongs to the authenticated user, it is updated. Otherwise,
        a new account is created.

        Only provided optional fields are written; omitted fields remain unchanged on update.

        **Permissions:** `root` or `producer`
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpsertAccountRequest'
            examples:
              create:
                summary: Create account with full details
                value:
                  account_id: 12345678
                  broker: ICMarkets
                  server: ICMarketsSC-Demo
                  currency: USD
                  leverage: 500
                  balance: 10000
                  equity: 10250.5
                  margin: 200
                  free_margin: 10050.5
                  profit: 250.5
                  margin_level: 5125.25
              update:
                summary: Update balance fields only
                value:
                  account_id: 12345678
                  balance: 10500
                  equity: 10500
      responses:
        '200':
          description: Account updated
          content:
            application/json:
              example:
                success: true
                data:
                  id: 12345678
        '201':
          description: Account created
          content:
            application/json:
              example:
                success: true
                data:
                  id: 12345678
        '403':
          description: Account belongs to another user
  /api/v1/strategies/:
    get:
      tags:
        - Strategies
      summary: List all strategies
      description: |
        Returns all trading strategies in the system.

        **Permissions:** `root` only
      responses:
        '200':
          description: List of strategies
          content:
            application/json:
              example:
                success: true
                data:
                  - id: 550e8400-e29b-41d4-a716-446655440000
                    account_id: 12345678
                    symbol: EURUSD
                    prefix: EU
                    name: Euro Scalper v2
                    magic_number: 100001
                    balance: '5000.00'
                    created_at: '2026-01-15T10:30:00+00:00'
                    updated_at: '2026-01-15T12:00:00+00:00'
                meta:
                  count: 1
        '403':
          description: Insufficient permissions (non-root user)
  /api/v1/strategy/:
    post:
      tags:
        - Strategies
      summary: Upsert strategy
      description: |
        Creates or updates a trading strategy. The strategy is linked to an account
        owned by the authenticated user.

        If a strategy with the given `id` already exists and its account belongs to
        the authenticated user, it is updated. Otherwise, a new strategy is created.

        **Permissions:** `root` or `producer`
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpsertStrategyRequest'
            example:
              id: 550e8400-e29b-41d4-a716-446655440000
              account_id: 12345678
              symbol: EURUSD
              prefix: EU
              name: Euro Scalper v2
              magic_number: 100001
              balance: 5000
      responses:
        '200':
          description: Strategy updated
          content:
            application/json:
              example:
                success: true
                data:
                  id: 550e8400-e29b-41d4-a716-446655440000
        '201':
          description: Strategy created
          content:
            application/json:
              example:
                success: true
                data:
                  id: 550e8400-e29b-41d4-a716-446655440000
        '403':
          description: Account or strategy belongs to another user
  /api/v1/heartbeat/:
    post:
      tags:
        - Heartbeats
      summary: Store heartbeat
      description: |
        Records a heartbeat event for a trading account or strategy.
        Used to track the lifecycle and health of running systems.

        **Permissions:** `root` or `producer`
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateHeartbeatRequest'
            examples:
              strategy_running:
                summary: Strategy running heartbeat
                value:
                  account_id: 12345678
                  strategy_id: 550e8400-e29b-41d4-a716-446655440000
                  event: on_running
                  system: strategy
              system_init:
                summary: System initialization
                value:
                  account_id: 12345678
                  event: on_init
                  system: system
      responses:
        '201':
          description: Heartbeat recorded
          content:
            application/json:
              example:
                success: true
        '403':
          description: Account belongs to another user
  /api/v1/order/:
    post:
      tags:
        - Orders
      summary: Upsert order
      description: |
        Creates or updates a trading order. Orders are stored in MongoDB.

        If an order with the given `id` already exists and its `account_id` matches,
        it is updated. Otherwise, a new order is created.

        **Permissions:** `root` or `producer`
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpsertOrderRequest'
            examples:
              new_order:
                summary: Create a new buy order
                value:
                  id: 550e8400-e29b-41d4-a716-446655440000
                  account_id: 12345678
                  strategy_id: 660e8400-e29b-41d4-a716-446655440000
                  symbol: EURUSD
                  side: buy
                  status: open
                  volume: 0.1
                  open_price: 1.105
                  stop_loss: 1.1
                  take_profit: 1.11
                  opened_at: '2026-02-27T10:30:00Z'
              close_order:
                summary: Update order to closed
                value:
                  id: 550e8400-e29b-41d4-a716-446655440000
                  account_id: 12345678
                  symbol: EURUSD
                  side: buy
                  status: closed
                  volume: 0.1
                  close_price: 1.108
                  profit: 30
                  close_reason: tp
                  closed_at: '2026-02-27T12:00:00Z'
      responses:
        '200':
          description: Order updated
          content:
            application/json:
              example:
                success: true
                data:
                  id: 550e8400-e29b-41d4-a716-446655440000
        '201':
          description: Order created
          content:
            application/json:
              example:
                success: true
                data:
                  id: 550e8400-e29b-41d4-a716-446655440000
        '403':
          description: Account belongs to another user
  /api/v1/log/:
    post:
      tags:
        - Logs
      summary: Store log entry
      description: |
        Records a log entry for a trading account or strategy.
        The `level` field is free-form (e.g. `info`, `warning`, `error`).

        **Permissions:** `root` or `producer`
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateLogRequest'
            examples:
              strategy_log:
                summary: Strategy info log
                value:
                  account_id: 12345678
                  strategy_id: 550e8400-e29b-41d4-a716-446655440000
                  level: info
                  message: 'Order #12345 opened at 1.10500'
              error_log:
                summary: System error log
                value:
                  account_id: 12345678
                  level: error
                  message: Connection to broker lost after 3 retries
      responses:
        '201':
          description: Log entry recorded
          content:
            application/json:
              example:
                success: true
        '403':
          description: Account belongs to another user
  /api/v1/account-snapshots/:
    get:
      tags:
        - Snapshots
      summary: List account snapshots
      description: |
        Returns paginated snapshots for a given account, ordered by `created_at` descending.

        **Permissions:** `root` only
      parameters:
        - name: account_id
          in: query
          required: true
          schema:
            type: integer
          description: The account ID to retrieve snapshots for.
        - name: page
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            default: 1
          description: Page number.
        - name: per_page
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 50
          description: Number of items per page.
      responses:
        '200':
          description: List of account snapshots
          content:
            application/json:
              example:
                success: true
                data:
                  - id: 6789abcdef012345
                    account_id: 12345678
                    balance: 10000
                    equity: 10250.5
                    profit: 250.5
                    margin_level: 5125.25
                    open_positions: 3
                    drawdown_pct: 2.5
                    daily_pnl: 150
                    floating_pnl: 100.5
                    open_order_count: 3
                    exposure_lots: 0.3
                    created_at: '2026-01-15T10:30:00+00:00'
                meta:
                  count: 1
                  pagination:
                    total: 50
                    page: 1
                    per_page: 50
                    total_pages: 1
        '400':
          description: Missing or invalid account_id
        '403':
          description: Insufficient permissions (non-root user)
  /api/v1/account-snapshot/:
    post:
      tags:
        - Snapshots
      summary: Store account snapshot
      description: |
        Records a point-in-time snapshot of an account's financial state.
        Used for historical tracking and analytics.

        **Permissions:** `root` or `producer`
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateAccountSnapshotRequest'
            example:
              account_id: 12345678
              balance: 10000
              equity: 10250.5
              profit: 250.5
              margin_level: 5125.25
              open_positions: 3
              drawdown_pct: 2.5
              daily_pnl: 150
              floating_pnl: 100.5
              open_order_count: 3
              exposure_lots: 0.3
      responses:
        '201':
          description: Snapshot recorded
          content:
            application/json:
              example:
                success: true
        '403':
          description: Account belongs to another user
  /api/v1/strategy-snapshots/:
    get:
      tags:
        - Snapshots
      summary: List strategy snapshots
      description: |
        Returns paginated snapshots for a given strategy, ordered by `created_at` descending.
        Optionally filter by `account_id`.

        **Permissions:** `root` only
      parameters:
        - name: strategy_id
          in: query
          required: true
          schema:
            type: string
            format: uuid
          description: The strategy ID to retrieve snapshots for.
        - name: account_id
          in: query
          required: false
          schema:
            type: integer
          description: Optional account ID filter.
        - name: page
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            default: 1
          description: Page number.
        - name: per_page
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 50
          description: Number of items per page.
      responses:
        '200':
          description: List of strategy snapshots
          content:
            application/json:
              example:
                success: true
                data:
                  - id: 6789abcdef012345
                    account_id: 12345678
                    strategy_id: 550e8400-e29b-41d4-a716-446655440000
                    nav: 5250
                    drawdown_pct: 1.25
                    daily_pnl: 75
                    floating_pnl: 50
                    open_order_count: 2
                    exposure_lots: 0.2
                    created_at: '2026-01-15T10:30:00+00:00'
                meta:
                  count: 1
                  pagination:
                    total: 50
                    page: 1
                    per_page: 50
                    total_pages: 1
        '400':
          description: Missing or invalid strategy_id
        '403':
          description: Insufficient permissions (non-root user)
  /api/v1/strategy-snapshot/:
    post:
      tags:
        - Snapshots
      summary: Store strategy snapshot
      description: |
        Records a point-in-time snapshot of a strategy's performance.
        Used for historical tracking and analytics.

        **Permissions:** `root` or `producer`
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateStrategySnapshotRequest'
            example:
              account_id: 12345678
              strategy_id: 550e8400-e29b-41d4-a716-446655440000
              nav: 5250
              drawdown_pct: 1.25
              daily_pnl: 75
              floating_pnl: 50
              open_order_count: 2
              exposure_lots: 0.2
      responses:
        '201':
          description: Snapshot recorded
          content:
            application/json:
              example:
                success: true
        '403':
          description: Account belongs to another user
components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
  parameters:
    ApiKeyId:
      name: id
      in: path
      required: true
      schema:
        type: string
        format: uuid
    AccountId:
      name: id
      in: path
      required: true
      description: MetaTrader account ID
      schema:
        type: integer
    EventId:
      name: event_id
      in: path
      required: true
      description: 24-character hex string (MongoDB ObjectId)
      schema:
        type: string
        pattern: ^[a-f0-9]{24}$
    FileName:
      name: file_name
      in: path
      required: true
      description: Unique file name returned by the upload endpoint
      schema:
        type: string
  schemas:
    LoginWithCredentials:
      type: object
      required:
        - email
        - password
      properties:
        email:
          type: string
          format: email
          minLength: 5
          maxLength: 254
          default: root@mail.co
        password:
          type: string
          format: password
          minLength: 8
          maxLength: 128
          default: 123456789*
    LoginWithApiKey:
      type: object
      required:
        - api_key
      properties:
        api_key:
          type: string
          minLength: 1
          maxLength: 256
          description: Plaintext API key.
    TokenPairResponse:
      type: object
      required:
        - success
        - data
      properties:
        success:
          type: boolean
          const: true
        data:
          type: object
          required:
            - access
            - refresh
            - expires_at
          properties:
            access:
              type: string
              description: Short-lived JWT access token.
            refresh:
              type: string
              description: Long-lived JWT refresh token.
            expires_at:
              type: integer
              description: Unix timestamp (seconds) when the access token expires.
    RefreshRequest:
      type: object
      required:
        - refresh
      properties:
        refresh:
          type: string
          minLength: 1
          description: The refresh token to exchange.
    LogoutRequest:
      type: object
      required:
        - refresh
      properties:
        refresh:
          type: string
          minLength: 1
          description: The refresh token to blacklist.
    UserProfile:
      type: object
      required:
        - success
        - data
      properties:
        success:
          type: boolean
          const: true
        data:
          type: object
          required:
            - id
            - email
            - role
            - created_at
          properties:
            id:
              type: string
              format: uuid
            email:
              type: string
              format: email
            role:
              type: string
              enum:
                - root
                - platform
                - producer
            created_at:
              type: string
              format: date-time
    CreateApiKeyRequest:
      type: object
      required:
        - name
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 100
          description: Human-readable label for the API key.
        allowed_ips:
          type: array
          items:
            type: string
            format: ipv4
          maxItems: 20
          default: []
          description: IP whitelist. Empty array allows all IPs.
        expires_at:
          type: string
          format: date-time
          nullable: true
          description: Optional expiration date. Null means no expiration.
    UpdateApiKeyRequest:
      type: object
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 100
        allowed_ips:
          type: array
          items:
            type: string
            format: ipv4
          maxItems: 20
        is_active:
          type: boolean
        expires_at:
          type: string
          format: date-time
          nullable: true
    EventKeyEnum:
      type: string
      enum:
        - post.order
        - get.order
        - put.order
        - delete.order
        - get.account
        - patch.account.disable
        - patch.account.enable
    PushEventRequest:
      type: object
      required:
        - key
        - payload
      properties:
        key:
          $ref: '#/components/schemas/EventKeyEnum'
        payload:
          type: object
          description: Validated against the event key schema. Max 65536 bytes, max 5 nesting levels.
    SuccessEnvelope:
      type: object
      required:
        - success
      properties:
        success:
          type: boolean
          const: true
        message:
          type: string
        data: {}
        meta:
          type: object
    EventStatus:
      type: string
      enum:
        - pending
        - delivered
        - processed
        - failed
    Event:
      type: object
      properties:
        id:
          type: string
        consumer_id:
          type: string
          nullable: true
        account_id:
          type: string
        user_id:
          type: string
        key:
          $ref: '#/components/schemas/EventKeyEnum'
        payload:
          type: object
        response:
          type: object
          nullable: true
        status:
          $ref: '#/components/schemas/EventStatus'
        delivered_at:
          type: string
          format: date-time
          nullable: true
        processed_at:
          type: string
          format: date-time
          nullable: true
        attempts:
          type: integer
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
    AckEventRequest:
      type: object
      properties:
        response:
          type: object
          nullable: true
          description: Optional response data. Max 65536 bytes, max 5 nesting levels.
    MediaFile:
      type: object
      properties:
        id:
          type: string
        account_id:
          type: string
        user_id:
          type: string
        file_name:
          type: string
        original_name:
          type: string
        content_type:
          type: string
        size:
          type: integer
        expires_at:
          type: string
          format: date-time
        created_at:
          type: string
          format: date-time
    UpsertAccountRequest:
      type: object
      required:
        - account_id
      properties:
        account_id:
          type: integer
        broker:
          type: string
          maxLength: 255
        server:
          type: string
          maxLength: 255
        currency:
          type: string
          maxLength: 10
        leverage:
          type: integer
          minimum: 1
        balance:
          type: number
          format: decimal
        equity:
          type: number
          format: decimal
        margin:
          type: number
          format: decimal
        free_margin:
          type: number
          format: decimal
        profit:
          type: number
          format: decimal
        margin_level:
          type: number
          format: decimal
    UpsertStrategyRequest:
      type: object
      required:
        - id
        - account_id
        - symbol
        - prefix
        - name
        - magic_number
        - balance
      properties:
        id:
          type: string
          format: uuid
        account_id:
          type: integer
        symbol:
          type: string
          maxLength: 50
        prefix:
          type: string
          maxLength: 50
        name:
          type: string
          maxLength: 255
        magic_number:
          type: integer
        balance:
          type: number
          format: decimal
    CreateHeartbeatRequest:
      type: object
      required:
        - account_id
        - event
        - system
      properties:
        account_id:
          type: integer
        strategy_id:
          type: string
          format: uuid
          nullable: true
        event:
          type: string
          enum:
            - on_init
            - on_running
            - on_deinit
            - on_error
        system:
          type: string
          enum:
            - strategy
            - system
    UpsertOrderRequest:
      type: object
      required:
        - id
        - account_id
        - symbol
        - side
        - status
        - volume
      properties:
        id:
          type: string
          format: uuid
        account_id:
          type: integer
        strategy_id:
          type: string
          format: uuid
          nullable: true
        deal_id:
          type: integer
          nullable: true
        position_id:
          type: integer
          nullable: true
        source:
          type: string
          maxLength: 50
        symbol:
          type: string
          maxLength: 50
        side:
          type: string
          maxLength: 10
        status:
          type: string
          enum:
            - pending
            - open
            - closing
            - closed
            - cancelled
        is_market_order:
          type: boolean
          default: false
        volume:
          type: number
          format: decimal
        signal_price:
          type: number
          format: decimal
          nullable: true
        open_at_price:
          type: number
          format: decimal
          nullable: true
        open_price:
          type: number
          format: decimal
          nullable: true
        close_price:
          type: number
          format: decimal
          nullable: true
        take_profit:
          type: number
          format: decimal
          nullable: true
        stop_loss:
          type: number
          format: decimal
          nullable: true
        profit:
          type: number
          format: decimal
          nullable: true
        gross_profit:
          type: number
          format: decimal
          nullable: true
        commission:
          type: number
          format: decimal
          nullable: true
        swap:
          type: number
          format: decimal
          nullable: true
        close_reason:
          type: string
          enum:
            - tp
            - sl
            - expert
            - client
            - mobile
            - web
            - unknown
          nullable: true
        signal_at:
          type: string
          format: date-time
          nullable: true
        opened_at:
          type: string
          format: date-time
          nullable: true
        closed_at:
          type: string
          format: date-time
          nullable: true
    CreateLogRequest:
      type: object
      required:
        - account_id
        - level
        - message
      properties:
        account_id:
          type: integer
        strategy_id:
          type: string
          format: uuid
          nullable: true
        level:
          type: string
          maxLength: 20
        message:
          type: string
          maxLength: 5000
    CreateAccountSnapshotRequest:
      type: object
      required:
        - account_id
        - balance
        - equity
        - profit
        - margin_level
        - open_positions
        - drawdown_pct
        - daily_pnl
        - floating_pnl
        - open_order_count
        - exposure_lots
      properties:
        account_id:
          type: integer
        balance:
          type: number
          format: decimal
        equity:
          type: number
          format: decimal
        profit:
          type: number
          format: decimal
        margin_level:
          type: number
          format: decimal
        open_positions:
          type: integer
          minimum: 0
        drawdown_pct:
          type: number
          format: decimal
        daily_pnl:
          type: number
          format: decimal
        floating_pnl:
          type: number
          format: decimal
        open_order_count:
          type: integer
          minimum: 0
        exposure_lots:
          type: number
          format: decimal
    CreateStrategySnapshotRequest:
      type: object
      required:
        - account_id
        - strategy_id
        - nav
        - drawdown_pct
        - daily_pnl
        - floating_pnl
        - open_order_count
        - exposure_lots
      properties:
        account_id:
          type: integer
        strategy_id:
          type: string
          format: uuid
        nav:
          type: number
          format: decimal
        drawdown_pct:
          type: number
          format: decimal
        daily_pnl:
          type: number
          format: decimal
        floating_pnl:
          type: number
          format: decimal
        open_order_count:
          type: integer
          minimum: 0
        exposure_lots:
          type: number
          format: decimal
    ApiKey:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        prefix:
          type: string
          description: First 8 characters of the key for identification.
        allowed_ips:
          type: array
          items:
            type: string
        is_active:
          type: boolean
        is_expired:
          type: boolean
        expires_at:
          type: string
          format: date-time
          nullable: true
        last_used_at:
          type: string
          format: date-time
          nullable: true
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
