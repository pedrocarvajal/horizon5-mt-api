login:
  post:
    tags: [Auth]
    summary: Login
    description: |
      Authenticates a user and returns a JWT access/refresh token pair.

      Supports two authentication modes (mutually exclusive):
      - **Email/Password:** Provide `email` and `password` fields.
      - **API Key:** Provide `api_key` field. The key is validated against stored hashes,
        IP whitelist is checked, and expiration/active status is verified.

      **Permissions:** Public (no authentication required).

      **Rate limiting (email/password mode):**
      - Per IP: 5 requests / 60 seconds
      - Per email: 10 requests / 3600 seconds
      - Account lockout: 10 consecutive failures locks the account for 900 seconds
    security: []
    requestBody:
      required: true
      content:
        application/json:
          schema:
            oneOf:
              - $ref: "../components/schemas.yaml#/LoginWithCredentials"
              - $ref: "../components/schemas.yaml#/LoginWithApiKey"
          examples:
            email_password:
              summary: Login with email and password
              value:
                email: "root@mail.co"
                password: "123456789*"
            api_key:
              summary: Login with API key
              value:
                api_key: "a1b2c3d4e5f6..."
    responses:
      "200":
        description: Login successful
        content:
          application/json:
            schema:
              $ref: "../components/schemas.yaml#/TokenPairResponse"
            example:
              success: true
              data:
                access: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
                refresh: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
                expires_at: 1772177505
      "401":
        description: Invalid credentials or inactive account
      "403":
        description: IP not allowed (API key mode only)

refresh:
  post:
    tags: [Auth]
    summary: Refresh token
    description: |
      Exchanges a valid refresh token for a new access/refresh pair.
      The old refresh token is blacklisted (rotation).

      **Permissions:** Public (no Bearer token required).

      **Rate limiting:** 10 requests / 60 seconds per IP.
    security: []
    requestBody:
      required: true
      content:
        application/json:
          schema:
            $ref: "../components/schemas.yaml#/RefreshRequest"
          example:
            refresh: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
    responses:
      "200":
        description: Token refreshed successfully
        content:
          application/json:
            schema:
              $ref: "../components/schemas.yaml#/TokenPairResponse"
            example:
              success: true
              data:
                access: "eyJ...(new)..."
                refresh: "eyJ...(new, rotated)..."
                expires_at: 1772178405
      "401":
        description: Refresh token is invalid, expired, or blacklisted
        content:
          application/json:
            example:
              success: false
              message: "Token is invalid or expired"
      "429":
        description: Rate limit exceeded

logout:
  post:
    tags: [Auth]
    summary: Logout
    description: |
      Invalidates the refresh token server-side by blacklisting it.
      Returns success even if the token is already blacklisted (idempotent).

      **Permissions:** Authenticated (Bearer token required).
    requestBody:
      required: true
      content:
        application/json:
          schema:
            $ref: "../components/schemas.yaml#/LogoutRequest"
          example:
            refresh: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
    responses:
      "200":
        description: Logged out successfully
        content:
          application/json:
            example:
              success: true
              message: "Logged out successfully"
      "401":
        description: Authentication credentials were not provided

me:
  get:
    tags: [Auth]
    summary: Current user profile
    description: |
      Returns the authenticated user's profile.

      **Permissions:** Authenticated (Bearer token required).
    responses:
      "200":
        description: User profile
        content:
          application/json:
            schema:
              $ref: "../components/schemas.yaml#/UserProfile"
            example:
              success: true
              data:
                id: "4cc3a1bf-76b5-41ee-931e-9afceeea96a1"
                email: "root@mail.co"
                role: "root"
                created_at: "2025-01-15T10:30:00+00:00"
      "401":
        description: Authentication credentials were not provided
